{% extends "base_minimal.html" %}

{% block title %}Чат с {{ other_user.nickname_enc }} - Harvest{% endblock %}

{% block head %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg);
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent);
        color: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }

    .chat-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .chat-user-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        display: flex;
        max-width: 70%;
    }

    .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.received {
        align-self: flex-start;
    }

    .message-content {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        position: relative;
        word-wrap: break-word;
    }

    .message.sent .message-content {
        background: var(--accent);
        color: var(--bg);
        border-color: var(--accent);
    }

    .message-text {
        margin-bottom: 0.25rem;
        line-height: 1.4;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        text-align: right;
    }

    .message.sent .message-time {
        color: var(--bg);
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border);
        background: var(--bg);
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        min-height: 40px;
        max-height: 120px;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 20px;
        background: var(--surface);
        color: var(--text);
        resize: none;
        font-family: inherit;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.1);
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent);
        color: var(--bg);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s;
    }

    .send-btn:hover {
        background: var(--accent-dim);
        transform: scale(1.05);
    }

    .file-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s;
    }

    .file-btn:hover {
        background: var(--accent);
        color: var(--bg);
    }

    .message-file {
        margin-bottom: 0.5rem;
    }

    .file-link {
        color: var(--accent);
        text-decoration: none;
        padding: 0.5rem;
        background: rgba(0, 255, 65, 0.1);
        border-radius: 6px;
        display: inline-block;
    }

    .edit-btn, .delete-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        margin-left: 0.5rem;
        font-size: 0.8rem;
    }

    .edit-btn:hover, .delete-btn:hover {
        color: var(--text);
    }

    .message-sender {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #4ecdc4;
    }

    .message.sent .message-sender {
        color: var(--bg);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
    }

    .modal-content h3 {
        margin-bottom: 1rem;
        color: var(--text);
    }

    .modal-content textarea {
        width: 100%;
        min-height: 80px;
        margin-bottom: 1rem;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .empty-chat {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: var(--text-dim);
        text-align: center;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Голосовые сообщения */
    .voice-message-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        border-radius: 20px;
        min-width: 200px;
        max-width: 280px;
        margin: 4px 0;
    }
    
    .voice-message-container.received {
        background: rgba(0, 255, 65, 0.15);
        border: 1px solid rgba(0, 255, 65, 0.3);
    }
    
    .voice-message-container.sent {
        background: linear-gradient(135deg, rgba(0, 255, 65, 0.8), rgba(0, 204, 51, 0.8));
        border: 1px solid rgba(0, 255, 65, 0.6);
    }
    
    .voice-play-button {
        background: var(--accent);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .voice-message-container.sent .voice-play-button {
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
    }
    
    .voice-play-button:hover {
        transform: scale(1.1);
    }
    
    .voice-waveform {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        position: relative;
        overflow: hidden;
    }
    
    .voice-message-container.sent .voice-waveform {
        background: rgba(0, 0, 0, 0.3);
    }
    
    .voice-progress {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s ease;
    }
    
    .voice-message-container.sent .voice-progress {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .voice-duration {
        font-size: 0.75rem;
        color: var(--text-dim);
        font-weight: 500;
        min-width: 35px;
        text-align: right;
        flex-shrink: 0;
    }
    
    .voice-message-container.sent .voice-duration {
        color: rgba(0, 0, 0, 0.8);
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 120px);
        }

        .message {
            max-width: 85%;
        }

        .chat-header {
            padding: 0.75rem;
        }

        .chat-user-name {
            font-size: 1rem;
        }

        .messages-container {
            padding: 0.75rem;
        }

        .chat-input-container {
            padding: 0.75rem;
        }
        
        .voice-message-container {
            min-width: 160px;
            max-width: 220px;
            padding: 10px 12px;
        }
        
        .voice-play-button {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-user-info">
            <div class="chat-avatar">
                {% if other_user.avatar %}
                    <img src="{{ url_for('static', filename=other_user.avatar) }}" alt="Аватар">
                {% else %}
                    {{ other_user.nickname_enc[0].upper() }}
                {% endif %}
            </div>
            <div class="chat-user-name">{{ other_user.nickname_enc }}</div>
        </div>
        <div class="chat-actions">
            <a href="{{ url_for('index') }}" class="btn">← Назад</a>
        </div>
    </div>

    <div class="messages-container" id="messages">
        {% if messages %}
            {% for message in messages %}
            <div class="message {{ 'sent' if message.sender_id == current_user.id else 'received' }}">
                <div class="message-content">
                    {% if message.sender_id != current_user.id %}
                    <div class="message-sender">{{ message.sender.nickname_enc }}</div>
                    {% endif %}
                    
                    {% if message.type == 'voice' and message.file_id %}
                    <!-- Голосовое сообщение -->
                    <div class="voice-message-container {{ 'sent' if message.sender_id == current_user.id else 'received' }}">
                        <button onclick="playVoiceMessage({{ message.file_id }}, this)" class="voice-play-button">
                            <span class="play-icon">▶️</span>
                            <span class="pause-icon" style="display: none;">⏸️</span>
                        </button>
                        <div class="voice-waveform">
                            <div class="voice-progress"></div>
                        </div>
                        <span class="voice-duration">{{ '%d:%02d'|format((message.voice_duration or 0) // 60, (message.voice_duration or 0) % 60) }}</span>
                    </div>
                    {% elif message.file %}
                    <!-- Обычные файлы -->
                    <div class="message-file">
                        <a href="{{ url_for('download_message_file', file_id=message.file.id) }}" class="file-link">
                            📁 {{ message.file.original_name }}
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if message.content_enc and message.content_enc|length > 0 %}
                    <div class="message-text">{{ message.content_enc.decode('utf-8') }}</div>
                    {% endif %}
                    <div class="message-time">
                        {{ message.timestamp.strftime('%H:%M') }}
                        {% if message.sender_id == current_user.id %}
                        <button class="edit-btn" onclick="editMessage({{ message.id }})">✏️</button>
                        <button class="delete-btn" onclick="deleteMessage({{ message.id }})">🗑️</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div class="empty-icon">💬</div>
                <p>Начните общение!</p>
                <p>Отправьте первое сообщение</p>
            </div>
        {% endif %}
    </div>

    <div class="chat-input-container">
        <!-- Интерфейс записи голосового сообщения -->
        <div id="recordingInterface" style="display: none; padding: 0.5rem; background: rgba(255, 0, 0, 0.1); border-radius: 6px; margin-bottom: 0.5rem; text-align: center;">
            <span>🎤 Запись...</span>
            <span id="recordingTimer">0:00</span>
            <button type="button" id="stopRecording" style="margin-left: 1rem; background: #00ff41; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">⏹️</button>
            <button type="button" id="cancelRecording" style="margin-left: 0.5rem; background: #ff4444; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">❌</button>
        </div>
        
        <form class="chat-input-form" onsubmit="sendMessage(event)">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
            <button type="button" class="file-btn" onclick="document.getElementById('fileInput').click()">📁</button>
            <button type="button" id="voiceButton" class="file-btn" title="Голосовое сообщение">🎤</button>
            <textarea 
                id="messageInput" 
                class="chat-input" 
                placeholder="Введите сообщение..." 
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button type="submit" class="send-btn">➤</button>
        </form>
        <div id="filePreview" style="display: none; padding: 0.5rem; background: var(--bg); border-radius: 6px; margin-bottom: 0.5rem;">
            <span id="fileName"></span>
            <button type="button" onclick="clearFile()" style="margin-left: 0.5rem;">❌</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
const socket = io();
const chatId = {{ chat.id }};
const currentUserId = {{ current_user.id }};
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');

// Подключение к чату
socket.emit('join_chat', {chat_id: chatId});

// Получение новых сообщений
socket.on('new_message', function(data) {
    addMessage(data);
    scrollToBottom();
    
    // Уведомление и звук только для чужих сообщений
    if (data.sender_id !== currentUserId) {
        showNotification('Новое сообщение', data.content, data.sender);
        playNotificationSound();
    }
});

// Получение голосовых сообщений
socket.on('voice_message_received', function(data) {
    addVoiceMessage(data);
    scrollToBottom();
    
    if (data.sender_id !== currentUserId) {
        showNotification('Голосовое сообщение', 'Голосовое сообщение', data.sender_name);
        playNotificationSound();
    }
});

// Отправка сообщения
function sendMessage(event) {
    event.preventDefault();
    const content = messageInput.value.trim();
    
    if (selectedFile) {
        // Отправка файла
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                socket.emit('send_message', {
                    chat_id: chatId,
                    content: content || '📁 Файл',
                    file_id: data.file_id
                });
                clearFile();
                messageInput.value = '';
                adjustTextareaHeight();
            }
        });
    } else if (content) {
        socket.emit('send_message', {
            chat_id: chatId,
            content: content
        });
        messageInput.value = '';
        adjustTextareaHeight();
    }
}

// Добавление сообщения в интерфейс
function addMessage(data) {
    if (data.type === 'voice') {
        addVoiceMessage(data);
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${data.sender_id === currentUserId ? 'sent' : 'received'}`;
    
    const time = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let senderHtml = '';
    if (data.sender_id !== currentUserId) {
        senderHtml = `<div class="message-sender">${data.sender}</div>`;
    }
    
    let fileHtml = '';
    if (data.file_id) {
        fileHtml = `<div class="message-file"><a href="/download_file/${data.file_id}" class="file-link">📁 Файл</a></div>`;
    }
    
    let editButtons = '';
    if (data.sender_id === currentUserId) {
        editButtons = `
            <button class="edit-btn" onclick="editMessage(${data.id})">✏️</button>
            <button class="delete-btn" onclick="deleteMessage(${data.id})">🗑️</button>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${senderHtml}
            ${fileHtml}
            ${data.content ? `<div class="message-text">${data.content}</div>` : ''}
            <div class="message-time">${time} ${editButtons}</div>
        </div>
    `;
    
    // Удаляем пустое состояние если есть
    const emptyChat = messagesContainer.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    messagesContainer.appendChild(messageDiv);
}

// Добавление голосового сообщения
function addVoiceMessage(data) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${data.sender_id === currentUserId ? 'sent' : 'received'}`;
    
    const time = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const duration = data.duration || 0;
    const mins = Math.floor(duration / 60);
    const secs = duration % 60;
    const formattedDuration = `${mins}:${secs.toString().padStart(2, '0')}`;
    
    let senderHtml = '';
    if (data.sender_id !== currentUserId) {
        senderHtml = `<div class="message-sender">${data.sender_name || 'Пользователь'}</div>`;
    }
    
    let editButtons = '';
    if (data.sender_id === currentUserId) {
        editButtons = `<button class="delete-btn" onclick="deleteMessage(${data.id})">🗑️</button>`;
    }
    
    const isOwn = data.sender_id === currentUserId;
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${senderHtml}
            <div class="voice-message-container ${isOwn ? 'sent' : 'received'}">
                <button onclick="playVoiceMessage(${data.file_id}, this)" class="voice-play-button">
                    <span class="play-icon">▶️</span>
                    <span class="pause-icon" style="display: none;">⏸️</span>
                </button>
                <div class="voice-waveform">
                    <div class="voice-progress"></div>
                </div>
                <span class="voice-duration">${formattedDuration}</span>
            </div>
            <div class="message-time">${time} ${editButtons}</div>
        </div>
    `;
    
    // Удаляем пустое состояние если есть
    const emptyChat = messagesContainer.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    messagesContainer.appendChild(messageDiv);
}

// Прокрутка к последнему сообщению
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Обработка Enter для отправки
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage(event);
    }
}

// Автоматическое изменение высоты textarea
function adjustTextareaHeight() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
}

messageInput.addEventListener('input', adjustTextareaHeight);

// Прокрутка к последнему сообщению при загрузке
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
});

let selectedFile = null;

// Обработка выбора файла
function handleFileSelect(event) {
    selectedFile = event.target.files[0];
    if (selectedFile) {
        document.getElementById('fileName').textContent = selectedFile.name;
        document.getElementById('filePreview').style.display = 'block';
    }
}

function clearFile() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
}

// Редактирование сообщения
function editMessage(messageId) {
    showEditModal(messageId);
}

// Удаление сообщения
function deleteMessage(messageId) {
    showDeleteModal(messageId);
}

function showEditModal(messageId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Редактировать сообщение</h3>
            <textarea id="editText" placeholder="Введите новый текст..."></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal()">Отмена</button>
                <button class="btn btn-primary" onclick="saveEdit(${messageId})">Сохранить</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('editText').focus();
}

function showDeleteModal(messageId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Удалить сообщение</h3>
            <p>Вы уверены, что хотите удалить это сообщение?</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal()">Отмена</button>
                <button class="btn btn-danger" onclick="confirmDelete(${messageId})">Удалить</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveEdit(messageId) {
    const newContent = document.getElementById('editText').value.trim();
    if (newContent) {
        fetch(`/message/edit/${messageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `content=${encodeURIComponent(newContent)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка редактирования');
            }
        });
    }
    closeModal();
}

function confirmDelete(messageId) {
    fetch(`/message/delete/${messageId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка удаления');
        }
    });
    closeModal();
}

function closeModal() {
    const modal = document.querySelector('.modal');
    if (modal) {
        modal.remove();
    }
}

// Уведомления
function showNotification(title, body, sender) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: `${sender}: ${body}`,
            icon: '/static/favicon.ico'
        });
    }
}

function playNotificationSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
    audio.volume = 0.3;
    audio.play().catch(() => {});
}

// Запрос разрешения на уведомления
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Отключение от чата при уходе со страницы
window.addEventListener('beforeunload', function() {
    socket.emit('leave_chat', {chat_id: chatId});
});

// Голосовые сообщения
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let startTime = null;
let recordingTimer = null;

// Инициализация голосовых сообщений
async function initVoiceMessages() {
    if (typeof MediaRecorder === 'undefined') {
        console.warn('MediaRecorder не поддерживается');
        document.getElementById('voiceButton').style.display = 'none';
        return;
    }
    
    // Настройка кнопок (без запроса микрофона)
    document.getElementById('voiceButton').addEventListener('click', requestMicrophoneAndRecord);
    document.getElementById('stopRecording').addEventListener('click', stopRecording);
    document.getElementById('cancelRecording').addEventListener('click', cancelRecording);
}

// Запрос микрофона и начало записи
async function requestMicrophoneAndRecord() {
    if (mediaRecorder) {
        toggleRecording();
        return;
    }
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            processRecording();
        };
        
        // Начинаем запись сразу после получения доступа
        startRecording();
        
    } catch (error) {
        console.error('Ошибка доступа к микрофону:', error);
        alert('Нет доступа к микрофону. Проверьте разрешения в браузере.');
    }
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function startRecording() {
    if (!mediaRecorder || isRecording) return;
    
    audioChunks = [];
    isRecording = true;
    startTime = Date.now();
    
    mediaRecorder.start();
    
    // Показываем интерфейс записи
    document.getElementById('recordingInterface').style.display = 'block';
    document.getElementById('voiceButton').style.background = '#ff4444';
    
    // Таймер
    let seconds = 0;
    recordingTimer = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('recordingTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        // Автостоп через 60 секунд
        if (seconds >= 60) {
            stopRecording();
        }
    }, 1000);
}

function stopRecording() {
    if (!isRecording) return;
    
    isRecording = false;
    mediaRecorder.stop();
    clearInterval(recordingTimer);
    
    // Скрываем интерфейс
    document.getElementById('recordingInterface').style.display = 'none';
    document.getElementById('voiceButton').style.background = '';
}

function cancelRecording() {
    if (!isRecording) return;
    
    isRecording = false;
    mediaRecorder.stop();
    clearInterval(recordingTimer);
    audioChunks = [];
    
    // Скрываем интерфейс
    document.getElementById('recordingInterface').style.display = 'none';
    document.getElementById('voiceButton').style.background = '';
}

async function processRecording() {
    if (audioChunks.length === 0) return;
    
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - startTime) / 1000);
    
    if (duration < 1) {
        alert('Слишком короткая запись');
        return;
    }
    
    // Загружаем файл
    const formData = new FormData();
    formData.append('voice', audioBlob, 'voice.webm');
    formData.append('duration', duration);
    
    try {
        const response = await fetch('/upload_voice', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Отправляем через SocketIO
            socket.emit('voice_message', {
                chat_id: chatId,
                file_id: result.file_id,
                duration: result.duration
            });
        } else {
            alert('Ошибка отправки голосового сообщения');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка отправки голосового сообщения');
    }
}

let currentAudio = null;
let currentButton = null;

// Воспроизведение голосового сообщения
function playVoiceMessage(fileId, button) {
    const playIcon = button.querySelector('.play-icon');
    const pauseIcon = button.querySelector('.pause-icon');
    const progressBar = button.parentElement.querySelector('.voice-progress');
    
    // Если уже играет это же сообщение - ставим на паузу
    if (currentAudio && currentButton === button) {
        if (currentAudio.paused) {
            currentAudio.play();
        } else {
            currentAudio.pause();
        }
        return;
    }
    
    // Останавливаем предыдущее аудио
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        // Сбрасываем предыдущую кнопку
        if (currentButton) {
            const prevPlay = currentButton.querySelector('.play-icon');
            const prevPause = currentButton.querySelector('.pause-icon');
            const prevProgress = currentButton.parentElement.querySelector('.voice-progress');
            if (prevPlay) prevPlay.style.display = 'inline';
            if (prevPause) prevPause.style.display = 'none';
            if (prevProgress) prevProgress.style.width = '0%';
        }
    }
    
    // Создаем новое аудио
    currentAudio = new Audio(`/voice/${fileId}`);
    currentButton = button;
    
    currentAudio.addEventListener('play', () => {
        if (playIcon) playIcon.style.display = 'none';
        if (pauseIcon) pauseIcon.style.display = 'inline';
    });
    
    currentAudio.addEventListener('pause', () => {
        if (playIcon) playIcon.style.display = 'inline';
        if (pauseIcon) pauseIcon.style.display = 'none';
    });
    
    currentAudio.addEventListener('ended', () => {
        if (playIcon) playIcon.style.display = 'inline';
        if (pauseIcon) pauseIcon.style.display = 'none';
        if (progressBar) progressBar.style.width = '0%';
        currentAudio = null;
        currentButton = null;
    });
    
    currentAudio.addEventListener('timeupdate', () => {
        if (progressBar && currentAudio.duration) {
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
            progressBar.style.width = `${progress}%`;
        }
    });
    
    currentAudio.play().catch(error => {
        console.error('Ошибка воспроизведения:', error);
    });
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    initVoiceMessages();
});
</script>
{% endblock %}