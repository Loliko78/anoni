{% extends "base_minimal.html" %}

{% block title %}–ß–∞—Ç —Å {{ other_user.nickname_enc }} - Harvest{% endblock %}

{% block head %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg);
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent);
        color: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }

    .chat-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .chat-user-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        display: flex;
        max-width: 70%;
    }

    .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.received {
        align-self: flex-start;
    }

    .message-content {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        position: relative;
        word-wrap: break-word;
    }

    .message.sent .message-content {
        background: var(--accent);
        color: var(--bg);
        border-color: var(--accent);
    }

    .message-text {
        margin-bottom: 0.25rem;
        line-height: 1.4;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        text-align: right;
    }

    .message.sent .message-time {
        color: var(--bg);
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border);
        background: var(--bg);
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        min-height: 40px;
        max-height: 120px;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 20px;
        background: var(--surface);
        color: var(--text);
        resize: none;
        font-family: inherit;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.1);
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent);
        color: var(--bg);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s;
    }

    .send-btn:hover {
        background: var(--accent-dim);
        transform: scale(1.05);
    }

    .file-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s;
    }

    .file-btn:hover {
        background: var(--accent);
        color: var(--bg);
    }

    .message-file {
        margin-bottom: 0.5rem;
    }

    .file-link {
        color: var(--accent);
        text-decoration: none;
        padding: 0.5rem;
        background: rgba(0, 255, 65, 0.1);
        border-radius: 6px;
        display: inline-block;
    }

    .edit-btn, .delete-btn {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        margin-left: 0.5rem;
        font-size: 0.8rem;
    }

    .edit-btn:hover, .delete-btn:hover {
        color: var(--text);
    }

    .message-sender {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #4ecdc4;
    }

    .message.sent .message-sender {
        color: var(--bg);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
    }

    .modal-content h3 {
        margin-bottom: 1rem;
        color: var(--text);
    }

    .modal-content textarea {
        width: 100%;
        min-height: 80px;
        margin-bottom: 1rem;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .empty-chat {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: var(--text-dim);
        text-align: center;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .voice-message-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        border-radius: 20px;
        min-width: 200px;
        max-width: 280px;
        margin: 4px 0;
    }
    
    .voice-message-container.received {
        background: rgba(0, 255, 65, 0.15);
        border: 1px solid rgba(0, 255, 65, 0.3);
    }
    
    .voice-message-container.sent {
        background: linear-gradient(135deg, rgba(0, 255, 65, 0.8), rgba(0, 204, 51, 0.8));
        border: 1px solid rgba(0, 255, 65, 0.6);
    }
    
    .voice-play-button {
        background: var(--accent);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .voice-message-container.sent .voice-play-button {
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
    }
    
    .voice-play-button:hover {
        transform: scale(1.1);
    }
    
    .voice-waveform {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        position: relative;
        overflow: hidden;
    }
    
    .voice-message-container.sent .voice-waveform {
        background: rgba(0, 0, 0, 0.3);
    }
    
    .voice-progress {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s ease;
    }
    
    .voice-message-container.sent .voice-progress {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .voice-duration {
        font-size: 0.75rem;
        color: var(--text-dim);
        font-weight: 500;
        min-width: 35px;
        text-align: right;
        flex-shrink: 0;
    }
    
    .voice-message-container.sent .voice-duration {
        color: rgba(0, 0, 0, 0.8);
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 120px);
        }

        .message {
            max-width: 85%;
        }

        .chat-header {
            padding: 0.75rem;
        }

        .chat-user-name {
            font-size: 1rem;
        }

        .messages-container {
            padding: 0.75rem;
        }

        .chat-input-container {
            padding: 0.75rem;
        }
        
        .voice-message-container {
            min-width: 160px;
            max-width: 220px;
            padding: 10px 12px;
        }
        
        .voice-play-button {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-user-info">
            <div class="chat-avatar">
                {% if other_user.avatar %}
                    <img src="{{ url_for('static', filename=other_user.avatar) }}" alt="–ê–≤–∞—Ç–∞—Ä">
                {% else %}
                    {{ other_user.nickname_enc[0].upper() }}
                {% endif %}
            </div>
            <div class="chat-user-name">{{ other_user.nickname_enc }}</div>
        </div>
        <div class="chat-actions">
            <a href="{{ url_for('index') }}" class="btn">‚Üê –ù–∞–∑–∞–¥</a>
        </div>
    </div>

    <div class="messages-container" id="messages">
        {% if messages %}
            {% for message in messages %}
            <div class="message {{ 'sent' if message.sender_id == current_user.id else 'received' }}">
                <div class="message-content">
                    {% if message.sender_id != current_user.id %}
                    <div class="message-sender">{{ message.sender.nickname_enc }}</div>
                    {% endif %}
                    
                    {% if message.type == 'voice' and message.file_id %}
                    <!-- –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                    <div class="voice-message-container {{ 'sent' if message.sender_id == current_user.id else 'received' }}">
                        <button onclick="playVoiceMessage({{ message.file_id }}, this)" class="voice-play-button">
                            <span class="play-icon">‚ñ∂Ô∏è</span>
                            <span class="pause-icon" style="display: none;">‚è∏Ô∏è</span>
                        </button>
                        <div class="voice-waveform">
                            <div class="voice-progress"></div>
                        </div>
                        <span class="voice-duration">{{ '%d:%02d'|format((message.voice_duration or 0) // 60, (message.voice_duration or 0) % 60) }}</span>
                    </div>
                    {% elif message.file %}
                    <!-- –û–±—ã—á–Ω—ã–µ —Ñ–∞–π–ª—ã -->
                    <div class="message-file">
                        <a href="{{ url_for('download_message_file', file_id=message.file.id) }}" class="file-link">
                            üìÅ {{ message.file.original_name }}
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if message.content_enc and message.content_enc|length > 0 %}
                    <div class="message-text">{{ message.content_enc.decode('utf-8') }}</div>
                    {% endif %}
                    <div class="message-time">
                        {{ message.timestamp.strftime('%H:%M') }}
                        {% if message.sender_id == current_user.id %}
                        <button class="edit-btn" onclick="editMessage({{ message.id }})">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteMessage({{ message.id }})">üóëÔ∏è</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div class="empty-icon">üí¨</div>
                <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
            </div>
        {% endif %}
    </div>

    <div class="chat-input-container">
        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="recordingInterface" style="display: none; padding: 0.5rem; background: rgba(255, 0, 0, 0.1); border-radius: 6px; margin-bottom: 0.5rem; text-align: center;">
            <span>üé§ –ó–∞–ø–∏—Å—å...</span>
            <span id="recordingTimer">0:00</span>
            <button type="button" id="stopRecording" style="margin-left: 1rem; background: #00ff41; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">‚èπÔ∏è</button>
            <button type="button" id="cancelRecording" style="margin-left: 0.5rem; background: #ff4444; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">‚ùå</button>
        </div>
        
        <form class="chat-input-form" onsubmit="sendMessage(event)">
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
            <button type="button" class="file-btn" onclick="document.getElementById('fileInput').click()">üìÅ</button>
            <button type="button" id="voiceButton" class="file-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üé§</button>
            <textarea 
                id="messageInput" 
                class="chat-input" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button type="submit" class="send-btn">‚û§</button>
        </form>
        <div id="filePreview" style="display: none; padding: 0.5rem; background: var(--bg); border-radius: 6px; margin-bottom: 0.5rem;">
            <span id="fileName"></span>
            <button type="button" onclick="clearFile()" style="margin-left: 0.5rem;">‚ùå</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
const socket = io();
const chatId = {{ chat.id }};
const currentUserId = {{ current_user.id }};
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É
socket.emit('join_chat', {chat_id: chatId});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
socket.on('new_message', function(data) {
    addMessage(data);
    scrollToBottom();
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (data.sender_id !== currentUserId) {
        showNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', data.content, data.sender);
        playNotificationSound();
    }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
socket.on('voice_message_received', function(data) {
    addVoiceMessage(data);
    scrollToBottom();
    
    if (data.sender_id !== currentUserId) {
        showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', data.sender_name);
        playNotificationSound();
    }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendMessage(event) {
    event.preventDefault();
    const content = messageInput.value.trim();
    
    if (selectedFile) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                socket.emit('send_message', {
                    chat_id: chatId,
                    content: content || 'üìÅ –§–∞–π–ª',
                    file_id: data.file_id
                });
                clearFile();
                messageInput.value = '';
                adjustTextareaHeight();
            }
        });
    } else if (content) {
        socket.emit('send_message', {
            chat_id: chatId,
            content: content
        });
        messageInput.value = '';
        adjustTextareaHeight();
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function addMessage(data) {
    if (data.type === 'voice') {
        addVoiceMessage(data);
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${data.sender_id === currentUserId ? 'sent' : 'received'}`;
    
    const time = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let senderHtml = '';
    if (data.sender_id !== currentUserId) {
        senderHtml = `<div class="message-sender">${data.sender}</div>`;
    }
    
    let fileHtml = '';
    if (data.file_id) {
        fileHtml = `<div class="message-file"><a href="/download_file/${data.file_id}" class="file-link">üìÅ –§–∞–π–ª</a></div>`;
    }
    
    let editButtons = '';
    if (data.sender_id === currentUserId) {
        editButtons = `
            <button class="edit-btn" onclick="editMessage(${data.id})">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="deleteMessage(${data.id})">üóëÔ∏è</button>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${senderHtml}
            ${fileHtml}
            ${data.content ? `<div class="message-text">${data.content}</div>` : ''}
            <div class="message-time">${time} ${editButtons}</div>
        </div>
    `;
    
    // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    const emptyChat = messagesContainer.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    messagesContainer.appendChild(messageDiv);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function addVoiceMessage(data) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${data.sender_id === currentUserId ? 'sent' : 'received'}`;
    
    const time = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const duration = data.duration || 0;
    const mins = Math.floor(duration / 60);
    const secs = duration % 60;
    const formattedDuration = `${mins}:${secs.toString().padStart(2, '0')}`;
    
    let senderHtml = '';
    if (data.sender_id !== currentUserId) {
        senderHtml = `<div class="message-sender">${data.sender_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>`;
    }
    
    let editButtons = '';
    if (data.sender_id === currentUserId) {
        editButtons = `<button class="delete-btn" onclick="deleteMessage(${data.id})">üóëÔ∏è</button>`;
    }
    
    const isOwn = data.sender_id === currentUserId;
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${senderHtml}
            <div class="voice-message-container ${isOwn ? 'sent' : 'received'}">
                <button onclick="playVoiceMessage(${data.file_id}, this)" class="voice-play-button">
                    <span class="play-icon">‚ñ∂Ô∏è</span>
                    <span class="pause-icon" style="display: none;">‚è∏Ô∏è</span>
                </button>
                <div class="voice-waveform">
                    <div class="voice-progress"></div>
                </div>
                <span class="voice-duration">${formattedDuration}</span>
            </div>
            <div class="message-time">${time} ${editButtons}</div>
        </div>
    `;
    
    // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    const emptyChat = messagesContainer.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    messagesContainer.appendChild(messageDiv);
}

// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage(event);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
function adjustTextareaHeight() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
}

messageInput.addEventListener('input', adjustTextareaHeight);

// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
});

let selectedFile = null;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
function handleFileSelect(event) {
    selectedFile = event.target.files[0];
    if (selectedFile) {
        document.getElementById('fileName').textContent = selectedFile.name;
        document.getElementById('filePreview').style.display = 'block';
    }
}

function clearFile() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function editMessage(messageId) {
    showEditModal(messageId);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function deleteMessage(messageId) {
    showDeleteModal(messageId);
}

function showEditModal(messageId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <textarea id="editText" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveEdit(${messageId})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('editText').focus();
}

function showDeleteModal(messageId) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-danger" onclick="confirmDelete(${messageId})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveEdit(messageId) {
    const newContent = document.getElementById('editText').value.trim();
    if (newContent) {
        fetch(`/message/edit/${messageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `content=${encodeURIComponent(newContent)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        });
    }
    closeModal();
}

function confirmDelete(messageId) {
    fetch(`/message/delete/${messageId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    });
    closeModal();
}

function closeModal() {
    const modal = document.querySelector('.modal');
    if (modal) {
        modal.remove();
    }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(title, body, sender) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: `${sender}: ${body}`,
            icon: '/static/favicon.ico'
        });
    }
}

function playNotificationSound() {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
    audio.volume = 0.3;
    audio.play().catch(() => {});
}

// –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —á–∞—Ç–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    socket.emit('leave_chat', {chat_id: chatId});
});

// –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let startTime = null;
let recordingTimer = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function initVoiceMessages() {
    if (typeof MediaRecorder === 'undefined') {
        console.warn('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        document.getElementById('voiceButton').style.display = 'none';
        return;
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
    document.getElementById('voiceButton').addEventListener('click', requestMicrophoneAndRecord);
    document.getElementById('stopRecording').addEventListener('click', stopRecording);
    document.getElementById('cancelRecording').addEventListener('click', cancelRecording);
}

// –ó–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
async function requestMicrophoneAndRecord() {
    if (mediaRecorder) {
        toggleRecording();
        return;
    }
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            processRecording();
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
        startRecording();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
    }
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function startRecording() {
    if (!mediaRecorder || isRecording) return;
    
    audioChunks = [];
    isRecording = true;
    startTime = Date.now();
    
    mediaRecorder.start();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø–∏—Å–∏
    document.getElementById('recordingInterface').style.display = 'block';
    document.getElementById('voiceButton').style.background = '#ff4444';
    
    // –¢–∞–π–º–µ—Ä
    let seconds = 0;
    recordingTimer = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('recordingTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        // –ê–≤—Ç–æ—Å—Ç–æ–ø —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
        if (seconds >= 60) {
            stopRecording();
        }
    }, 1000);
}

function stopRecording() {
    if (!isRecording) return;
    
    isRecording = false;
    mediaRecorder.stop();
    clearInterval(recordingTimer);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    document.getElementById('recordingInterface').style.display = 'none';
    document.getElementById('voiceButton').style.background = '';
}

function cancelRecording() {
    if (!isRecording) return;
    
    isRecording = false;
    mediaRecorder.stop();
    clearInterval(recordingTimer);
    audioChunks = [];
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    document.getElementById('recordingInterface').style.display = 'none';
    document.getElementById('voiceButton').style.background = '';
}

async function processRecording() {
    if (audioChunks.length === 0) return;
    
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - startTime) / 1000);
    
    if (duration < 1) {
        alert('–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è –∑–∞–ø–∏—Å—å');
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
    const formData = new FormData();
    formData.append('voice', audioBlob, 'voice.webm');
    formData.append('duration', duration);
    
    try {
        const response = await fetch('/upload_voice', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ SocketIO
            socket.emit('voice_message', {
                chat_id: chatId,
                file_id: result.file_id,
                duration: result.duration
            });
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
}

let currentAudio = null;
let currentButton = null;

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function playVoiceMessage(fileId, button) {
    const playIcon = button.querySelector('.play-icon');
    const pauseIcon = button.querySelector('.pause-icon');
    const progressBar = button.parentElement.querySelector('.voice-progress');
    
    // –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ—Ç —ç—Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
    if (currentAudio && currentButton === button) {
        if (currentAudio.paused) {
            currentAudio.play();
        } else {
            currentAudio.pause();
        }
        return;
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞—É–¥–∏–æ
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–Ω–æ–ø–∫—É
        if (currentButton) {
            const prevPlay = currentButton.querySelector('.play-icon');
            const prevPause = currentButton.querySelector('.pause-icon');
            const prevProgress = currentButton.parentElement.querySelector('.voice-progress');
            if (prevPlay) prevPlay.style.display = 'inline';
            if (prevPause) prevPause.style.display = 'none';
            if (prevProgress) prevProgress.style.width = '0%';
        }
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∞—É–¥–∏–æ
    currentAudio = new Audio(`/voice/${fileId}`);
    currentButton = button;
    
    currentAudio.addEventListener('play', () => {
        if (playIcon) playIcon.style.display = 'none';
        if (pauseIcon) pauseIcon.style.display = 'inline';
    });
    
    currentAudio.addEventListener('pause', () => {
        if (playIcon) playIcon.style.display = 'inline';
        if (pauseIcon) pauseIcon.style.display = 'none';
    });
    
    currentAudio.addEventListener('ended', () => {
        if (playIcon) playIcon.style.display = 'inline';
        if (pauseIcon) pauseIcon.style.display = 'none';
        if (progressBar) progressBar.style.width = '0%';
        currentAudio = null;
        currentButton = null;
    });
    
    currentAudio.addEventListener('timeupdate', () => {
        if (progressBar && currentAudio.duration) {
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
            progressBar.style.width = `${progress}%`;
        }
    });
    
    currentAudio.play().catch(error => {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    initVoiceMessages();
});
</script>
{% endblock %}